(TODO: review more thoroughly for new bugs.) Let's assume this is an equivalent rewrite of the code.

Effect on the old behavior: must be equivalent (not checked thoroughly).

1. Perhaps it would be easier to review if non-similar changes were
placed in separate commits (grouping the similar changes such as:
"Replace legacy int types.")

2. Was it necessary to make the changes in spacing (which can be
hidden with git diff -w)? If yes, it would be easier to review if they
were in a separate commit.
