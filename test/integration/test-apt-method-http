#!/bin/bash
set -e

TESTDIR=$(readlink -f $(dirname $0))
. $TESTDIR/framework

setupenvironment

nginxsetuphttp

buildpackage 'simple-package'

generaterepository "$TMPWORKINGDIRECTORY/usr/src/RPM/RPMS" "$TMPWORKINGDIRECTORY/nginx/repo"

cat > $TMPWORKINGDIRECTORY/rootdir/etc/apt/sources.list << END
rpm http://localhost:$((8080+PARALLEL_SLOT))/ $APT_TEST_USED_ARCH apt-tests
rpm http://localhost:$((8080+PARALLEL_SLOT))/ noarch apt-tests
END

nginxstart

testsuccess aptget update

testpkgnotinstalled 'simple-package'
testsuccess aptget install simple-package
testpkginstalled 'simple-package'
